# Spring boot actuator vulnerability solution

## Problem

系统暴露了 Spring Boot Actuator 的端点，攻击者可以通过端点获取敏感信息，进而导致系统被攻击。

详细信息请参考：[Spring Boot Actuator Endpoint Security](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-endpoints-security)

- /actuator 可列举开放的端点
- /actuator/env 可获取系统环境变量
- /actuator/heapdump 可获取系统堆内存转储文件

[JSON data listed in actuator env](resources/actuator-env.json)

1. 通过/actuator/env 获取关键信息

   可以搜索**\*\***找到敏感信息的 key，如：spring.datasource.password。

   - config.authentication.default_password
   - jwt.secret
   - SPRING_DATASOURCE_URL
   - SPRING_DATASOURCE_PASSWORD

2. 通过/actuator/heapdump 获取堆内存转储文件

   使用 VisualVM 打开堆内存转储文件，并安装 OQL 插件，可以使用 OQL 语句查询敏感信息。

   ```sql
   select s.key from java.util.LinkedHashMap$Entry s where /password/.test(s.key.toString())

   select s.value from java.util.LinkedHashMap$Entry s where /password/.test(s.key.toString())
   ```

   可尝试搜索其他关键字，如：token、secret 等。

3. 通过找到的数据库连接等信息，可以连接数据库，获取数据库中的敏感信息。虽然该 heapdump 中暴露出的密码只是具有单库权限的密码，但系统中可能存在多个数据库，攻击者可以通过该密码连接数据库，获取其他数据库的敏感信息。部分数据库可能存在弱口令，攻击者可以通过该密码进行登录。

## Solution

1. 关闭 Spring Boot Actuator 的端点

   ```yaml
   management:
     endpoints:
       web:
         exposure:
           include: "*"
   ```

   修改为

   ```yaml
   management:
     endpoints:
       web:
         exposure:
           include: "health,info"
   ```

2. 通过 Spring Security 配置 Spring Boot Actuator 的端点

   ```yaml
   spring:
     security:
       user:
       name: <your endpoint username>
       password: <your password>
       roles: ENDPOINT_ADMIN
   ```

   ```java
   @Configuration(proxyBeanMethods = false)
   public class MySecurityConfiguration {

       @Bean
       public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
           http.requestMatcher(EndpointRequest.toAnyEndpoint());
           http.authorizeRequests((requests) -> requests.anyRequest().hasRole("ENDPOINT_ADMIN"));
           http.httpBasic(withDefaults());
           return http.build();
       }
   }
   ```

3. 修改 management.server.port 为其他端口，默认与 server.port 是相同的 8080，可以修改为其他端口，如：8081。

   目的是可以通过防火墙保护该端口仅允许内网访问。

   ```yaml
   management:
     server:
       port: 8081
   ```

   修改为

   ```yaml
   management:
     server:
       port: 0
   ```

4. 移除 application.properties, application.yml 中的 spring.datasource.password, jwt.secret 等配置，改为从环境变量中获取

5. 数据库安全配置

   - 修改数据库配置，仅允许内网/指定 IP 可访问
   - 修改数据库密码，防止弱口令被暴力破解

6. 配置 code scan 工具，如：SonarQube，对代码进行扫描，发现敏感信息，如：密码、token、secret 等。

   - [SonarQube](https://www.sonarqube.org/)
   - [SonarCloud](https://sonarcloud.io/)
   - [SonarLint](https://www.sonarlint.org/)
   - [SonarQube Scanner](https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/)

## Reference

- [Spring Boot Actuator Endpoint Security](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-endpoints-security)

- [Spring Boot Actuator Endpoint Exposure](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-endpoints-exposure)

- [Spring Boot Actuator Endpoint Configuration](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-endpoints-configuration)
