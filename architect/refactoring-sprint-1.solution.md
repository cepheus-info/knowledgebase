# Refactoring Sprint 1

## 1. Overview

优化任务的目标是通过 Strangler Pattern 来升级系统。下面是第一次迭代的优化计划。

## 2. 优化目标

### 2.1. 优化范围及解决方案

#### 2.1.1. 事件记录 <-> 变动记录 <-> 变动花名册 三相⼀致性检查

变动记录与变动花名册数据提供在不同的服务中，在各自服务中分别提供查询会产生较大的性能开销及增加系统耦合性。因此，我们将在 maintenance 服务中对 mono 库与 fund 库提供统一的查询，以及对三者数据的⼀致性检查。

一致的判断标准包括:

1. 同一基金月份内，各单位的变动记录数与变动花名册记录数相等

2. 同一基金月份内，逐条比对变动记录与变动花名册记录，各字段值相等，可采用对哈希值的比对来提高效率

3. 对事件记录，可以通过一个特别的 Materialized View 来实现，该 Materialized View 的数据来源于事件记录，该 Materialized View 的数据结构与变动记录相同，但是该 Materialized View 的数据是只读的，不可修改，不可删除，不可新增，只能通过事件记录来修改，删除，新增。

   为保证高效，应当采取类似事件的方式，在 EventHandler 中只 insert 数据。通过此方式收集的记录表，可以用于与其余两份业务数据进行比对。

#### 2.1.2. 异常数据监控，数据检测与修复⼯具，提高现场数据问题处理效率的辅助功能

1、基⾦数据未删除：变动记录中已经删除的记录在基⾦中仍然存在，或变动记录中只有⼀条的在基⾦中存在多条。2、基金核定表错误数据

通过对基金数据的检测，以及对基金数据的修复工具，可以提高现场修复数据问题的效率。

目前，基金数据只能在数据库中进行删除，通过本次迭代，可以在统一的维护界面中提供删除。

#### 2.1.3. 基于人员的事件重放

事件重放是目前系统中的一个重要功能，但是目前依赖于手动修改 token_entry 表来实现，但这种方式是全库重放，风险较高，因此通常都是离线重放。

通过本次迭代，可以在统一的维护界面中提供事件重放功能。
重放即重新运行 EventHandlers，重放的范围可以是某个 Processing Group，也可以是某个 EventHandler。

- [ ] 添加 Processing Group 注解，用于标识 Processing Group
      只有在 Processing Group 中的 EventHandlers 才能被手动重放

- [ ] 提供接口，用于手动重放某个 Processing Group
      此接口只能提供在各个业务系统中，不能提供在 maintenance 系统中

- [ ] 提供选取重放对象的界面

#### 2.1.4. 事件 Dead Letter Queue
