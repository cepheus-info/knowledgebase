# 遗留接口性能优化

## 1. 问题描述

目前系统中存在大量响应较慢的数据接口，这些接口在并发较高时会导致系统性能下降，甚至出现大面积响应超时，影响一般接口响应的情况。

## 2. 问题分析

| No.      | 标题                                                       | 问题原因                                       | 解决方案                                                                             |
| -------- | ---------------------------------------------------------- | ---------------------------------------------- | ------------------------------------------------------------------------------------ |
| 2584     | 【数据库异常】死锁问题                                     | 连接池耗尽；<br> 数据库锁定；                  | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| 1652     | 【绩效批量变动】人多的单位加载人员时间较长                 | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| 2399     | 删除 7 条变动记录超过 1 分钟，操作批量晋升缓慢             | 数据库锁定；随机写；系统吞吐量低               | [3.1. 优化数据库操作](#31-优化数据库操作) <br> [3.3. 服务接口治理](#33-服务接口治理) |
| Bug 1512 | 退休人员预测查询缓慢                                       | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| Bug 253  | 社保卡维护进度查询时加载缓慢                               | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| Bug 2381 | 管理版信息查询-人员信息查询，数量超 12000 不能导出         | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| Bug 336  | 批量操作需要增加排队机制                                   | 批量操作需要排队；                             | [3.2. 请求队列](#32-请求队列)                                                        |
| Bug 2389 | 调整年人均绩效网络错误                                     | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| Bug 2398 | 人多的单位，首页中间的待退休等列表加载缓慢，界面无进度提示 | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| Bug 1547 | 核定 100+单位，网络错误                                    | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作) <br> [3.2. 请求队列](#32-请求队列)         |
| Bug 1313 | 变动花名册查看，页面很卡，包括切换报表，条件搜索，滚动条   | 待观察                                         | -                                                                                    |
| Bug 1143 | 津补贴批量变动，删除变动，网络错误                         | 数据库锁定；随机写；                           | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| Bug 1092 | 2000 条数据导出，始终转圈，甚至导致整个系统非常慢          | 数据库锁定；                                   | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |
| Bug 2552 | 并发问题，多家单位做批量变动，存在进度无法结束的情况       | 连接池耗尽；数据库锁定；随机写；系统吞吐量低； | [3.1. 优化数据库操作](#31-优化数据库操作) <br> [3.3. 服务接口治理](#33-服务接口治理) |
| Bug -    | 人员减少，目标单位列表加载缓慢                             | 数据库慢查询；                                 | [3.1. 优化数据库操作](#31-优化数据库操作)                                            |

## 3. 解决方案

### 3.1. 优化数据库操作

#### 3.1.1 连接池耗尽

- 事务过长会导致数据库连接池耗尽，无法处理新的请求，从而导致系统性能下降，甚至出现超时的情况。

- 连接池配置过小同样会导致数据库连接池耗尽。需要对 hikari 连接池参数进行调优。

  ```yaml
  hikari:
    minimum-idle: 10
    maximum-pool-size: 100
  ```

#### 3.1.2 数据库锁定

数据库锁定分为 Blocking Lock 和 Dead Lock。

- Dead Lock

  - 调整事务中的操作顺序，避免出现循环依赖的情况。确保出现死锁的 Transaction 中对表的操作顺序一致。

  - 优化事务，减少事务长度。

  - 减少事务对记录的锁定时间，例如将事务中的查询操作提前，避免在事务中对记录进行查询。

  - 减少事务中对记录的锁定数量。

- Blocking Lock

  - 优化事务，减少事务长度。

#### 3.1.3. 数据库查询

慢查询会在较大程度上影响系统性能，甚至导致系统崩溃。可以通过数据库慢查询日志，对慢查询进行优化。

#### 3.1.4. 数据库随机插入

数据库随机插入会导致数据库页分裂，降低数据库性能。当使用 UUID 作为主键时，批量插入无法利用磁盘顺序写入的特性，导致数据库频繁的 IO 操作，降低数据库性能。应当将该 UUID 设置为 Non-Clustered 索引，另外设置一个惟一字段作为 Clustered 索引或者使用自增主键。

### 3.2 请求队列

系统中存在大量提交批量数据的接口，这些接口在数据量较大时会导致系统性能下降，甚至出现超时的情况。可以通过请求队列的方式，将请求转发到消息队列中，由消息队列异步处理。

系统中使用 Kafka Handler 的接口包括基础信息批量变动；津补贴批量变动；批量晋升。

将请求队列逻辑应用到其余接口中，可以有效防止系统崩溃。

### 3.3 服务接口治理

对批量接口高并发访问时会出现吞吐量过大，导致系统性能下降，甚至出现超时的情况。可以通过服务接口治理的方式，对批量接口进行限流。Spring Boot 中可以通过 Resilience4j 框架，可以对接口进行限流。

#### 3.3.1 Bulkhead

Bulkhead 模式是一种隔离模式，它可以将应用程序的不同部分隔离开来，以防止它们相互干扰，从而提高系统的整体弹性。Bulkhead 模式可以防止应用程序的一部分的故障或高负载影响应用程序的其他部分。

Resilience4j 提供了两种 Bulkhead 模式：SemaphoreBulkhead 和 ThreadPoolBulkhead。可以在 Reactive Gateway 中通过配置文件对接口进行 Bulkhead 隔离。

```yaml
# Resilience4j bulkhead
resilience4j:
  bulkhead:
    configs:
      default:
        max-concurrent-calls: 100
        max-wait-duration: 0
        max-queueing-duration: 0
        writable-stack-trace-enabled: true
    instances:
      bulkhead:
        base-config: default
```

#### 3.3.2 Rate Limiter

Rate Limiter 模式是一种限流模式，它可以限制应用程序的某些部分的访问速率，以防止它们超过其容量。

Resilience4j 提供了两种 Rate Limiter 模式：SemaphoreBasedRateLimiter 和 TimeLimiter。可以在 Reactive Gateway 中通过配置文件对接口进行 Rate Limiter 限流。

```yaml
# Resilience4j rate limiter
resilience4j:
  rate-limiter:
    configs:
      default:
        limit-for-period: 100
        limit-refresh-period: 1s
        timeout-duration: 0
        writable-stack-trace-enabled: true
    instances:
      rateLimiter:
        base-config: default
```

## 4. 总结

- 通过优化事务，减少事务长度，可以有效避免数据库连接池耗尽，无法处理新的请求的情况。
- 通过请求队列的方式，将请求转发到消息队列中，由消息队列异步处理，可以有效防止系统崩溃。
- 通过服务接口治理的方式，对批量接口进行限流，可以有效防止系统性能下降，甚至出现超时的情况。
